# VRChat OSC 语音识别通信工具

一个功能强大的VRChat OSC通信程序，专为实时语音识别和智能语音交互设计。支持中日双语识别，具备智能断句、多模式录制和完善的调试功能。

## ✨ 核心特性

### 🎤 智能语音识别
- **实时语音监听**: 基于VRChat语音状态的智能语音检测
- **智能断句**: 自动检测语音停顿，避免录制过长或过短
- **多语言支持**: 中文（zh-CN）和日语（ja-JP）语音识别
- **GPU加速**: 支持CUDA加速的Whisper模型推理
- **多模式录制**: VRChat状态检测 + 纯音频检测双重保障

### 🎛️ 高级控制功能
- **OSC调试模式**: 实时监控VRChat发送的OSC参数
- **录制模式选择**: 正常模式、强制备用模式、禁用备用模式
- **实时参数调节**: 语音阈值、断句间隔可实时调整
- **连接诊断**: 自动诊断OSC连接问题并提供解决方案
- **详细状态显示**: 完整的系统状态和调试信息

### 💬 通信功能
- **聊天消息发送**: 文字和语音消息发送到VRChat
- **Avatar参数控制**: 双向OSC参数通信
- **实时状态监控**: 监听VRChat语音状态变化
- **多语言界面**: 支持中文和日语界面

## 🛠️ 系统要求

### 基本要求
- **Python**: 3.7+ 
- **操作系统**: Windows/macOS/Linux
- **硬件**: 麦克风、推荐4GB+内存
- **软件**: VRChat游戏客户端

### GPU支持（可选）
- **NVIDIA GPU**: 支持CUDA的显卡（推荐用于加速）
- **显存**: 建议2GB+用于语音模型加载

## 📦 安装指南

### 1. 获取项目
```bash
git clone <repository-url>
cd VRchatOSC
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 平台特殊设置

#### Windows
如果遇到PyAudio安装问题：
```bash
pip install pipwin
pipwin install pyaudio
```

#### macOS
```bash
brew install portaudio
pip install pyaudio
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt-get install portaudio19-dev python3-pyaudio
pip install pyaudio
```

## ⚙️ VRChat OSC 配置

### VRChat 设置
1. 启动VRChat
2. 进入 **Settings** → **OSC**
3. 启用 **"Enabled"**
4. 确认端口设置：
   - **Incoming**: 9000
   - **Outgoing**: 9001
5. **重启VRChat**（重要！）

### 账户要求
- VRChat账户等级需要为 **"New User"** 及以上
- 确保有聊天权限（未被静音）

## 🚀 使用方法

### 图形界面模式（推荐）

```bash
python ui/vrchat_osc_gui.py
```

#### 界面说明

##### 连接设置
- **主机地址**: 127.0.0.1（本地）
- **发送端口**: 9000（发送到VRChat）
- **接收端口**: 9001（从VRChat接收）
- **界面语言**: 中文/日本語切换

##### 消息发送
- **文字消息**: 直接输入发送或按回车
- **语音文件**: 上传音频文件自动识别发送
- **实时监听**: 点击"开始监听"进行持续语音识别

##### 高级设置
- **OSC调试模式**: 查看实际接收的VRChat参数
- **强制备用模式**: 强制使用纯音频检测（不依赖VRChat）
- **禁用备用模式**: 只使用VRChat语音状态（默认启用）
- **语音阈值**: 调节语音检测灵敏度（0.005-0.05）
- **断句间隔**: 调节自动断句检测时间（0.2-1.0秒）

##### 参数控制
- **Avatar参数**: 发送自定义参数到VRChat Avatar
- **实时监控**: 接收并显示VRChat发送的参数变化

## 🔧 录制模式详解

### 1. 正常模式（默认）
- 等待VRChat发送语音状态参数
- 只在检测到VRChat语音活动时录制
- 最精准，避免误录制环境音

### 2. 备用模式（自动切换）
- 30秒内未收到VRChat参数时自动启用
- 使用纯音频能量检测
- 确保在VRChat OSC异常时仍可工作
- **默认禁用**，可在设置中启用

### 3. 强制备用模式
- 手动启用纯音频检测
- 不依赖VRChat状态
- 适用于VRChat OSC功能异常时

## 🎯 智能断句技术

### 检测算法
- **多指标分析**: 结合RMS能量、过零率、频谱分析
- **动态阈值**: 根据语音长度调整停止条件
- **置信度评估**: 句子边界检测置信度计算
- **实时反馈**: 显示断句检测状态和置信度

### 参数调节
- **断句间隔**: 控制句子间停顿检测时间
- **语音阈值**: 调整语音活动检测灵敏度
- **最大录制时长**: 防止录制过长（8秒）
- **最小语音时长**: 确保有效语音（0.3秒）

## 🛠️ 故障排除

### 常见问题诊断

#### 1. 无法检测到VRChat语音
**症状**: 系统显示"等待VRChat语音参数"

**解决方案**:
1. 启用"OSC调试模式"查看接收参数
2. 确认VRChat OSC设置已启用
3. 重启VRChat应用程序
4. 检查防火墙是否阻止UDP通信
5. 尝试切换到"强制备用模式"

#### 2. 语音识别不准确
**可能原因**:
- 环境噪音过大
- 麦克风音量不当
- 语言设置错误

**解决方案**:
1. 调整语音阈值设置
2. 检查麦克风设备和音量
3. 确认选择正确的识别语言
4. 在安静环境中测试

#### 3. 录制时间过长/过短
**解决方案**:
1. 调整"断句间隔"设置
2. 修改语音阈值
3. 检查VRChat语音状态检测

#### 4. 程序连接失败
**解决方案**:
1. 确认VRChat正在运行
2. 检查端口9000/9001是否被占用
3. 临时关闭防火墙测试
4. 查看"显示状态"获取详细诊断

### 使用调试功能

#### 状态诊断
点击"显示状态"按钮查看：
- OSC连接状态
- VRChat参数接收情况  
- 语音引擎状态
- 系统配置信息
- 连接诊断建议

#### OSC调试模式
启用后可查看：
- 实时接收的OSC参数
- 参数名称和数值
- VRChat语音状态变化

## 📁 项目结构

```
VRchatOSC/
├── ui/
│   └── vrchat_osc_gui.py          # 图形用户界面
├── src/
│   ├── vrchat_controller.py       # VRChat控制器
│   ├── osc_client.py              # OSC客户端
│   └── voice/
│       └── engine.py              # 语音识别引擎
├── requirements.txt               # 依赖列表
└── README.md                     # 项目说明
```

## 🔧 技术架构

### 语音处理流程
1. **音频采集**: 实时麦克风音频流
2. **语音检测**: 多指标语音活动检测
3. **动态录制**: 智能开始/结束判断
4. **断句分析**: AI断句边界检测
5. **语音识别**: Whisper模型转文字
6. **消息发送**: OSC协议发送至VRChat

### OSC通信协议

#### 发送消息
```python
/chatbox/input [message, send_immediately, show_in_chatbox]
/avatar/parameters/{param_name} [value]
```

#### 接收消息
```python
/avatar/parameters/Voice [float]          # 语音强度
/avatar/parameters/VoiceLevel [float]     # 语音级别  
/avatar/parameters/Viseme [int]           # 口型参数
# 以及其他Avatar自定义参数
```

### 性能优化
- **GPU加速**: CUDA支持的Whisper推理
- **多线程**: 异步音频处理和识别
- **内存管理**: 动态音频缓冲区管理
- **智能缓存**: 模型加载和参数缓存

## 📄 许可证

MIT License - 可自由使用、修改和分发
---

**享受在VRChat中的智能语音交流体验！** 🎉